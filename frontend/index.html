<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAG Retrieval System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(rgba(0, 0, 0, 0.3), rgba(0, 0, 0, 0.3)), url('assets/background.jpg') no-repeat center center fixed;
            background-size: cover;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            padding: 30px;
            margin-bottom: 20px;
        }

        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .search-input {
            flex: 1;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .search-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .search-button {
            padding: 15px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .search-button:hover {
            transform: translateY(-2px);
        }

        .search-button:active {
            transform: translateY(0);
        }

        .search-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .parameters {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .param-group {
            display: flex;
            flex-direction: column;
        }

        .param-group label {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 5px;
        }

        .param-group input {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 0.95rem;
        }

        .results-container {
            margin-top: 20px;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e0e0e0;
        }

        .results-header h2 {
            color: #333;
            font-size: 1.5rem;
        }

        .results-count {
            color: #666;
            font-size: 0.95rem;
        }

        .result-item {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .result-item:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .result-id {
            font-size: 0.85rem;
            color: #667eea;
            font-weight: 600;
        }

        .result-score {
            background: #667eea;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .result-content {
            color: #333;
            line-height: 1.6;
            margin-bottom: 10px;
        }

        .result-metadata {
            font-size: 0.85rem;
            color: #666;
            background: white;
            padding: 10px;
            border-radius: 6px;
            margin-top: 10px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
        }

        .error {
            background: #fee;
            color: #c33;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #c33;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state svg {
            width: 80px;
            height: 80px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .info-section {
            background: #f0f4ff;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
        }

        .info-section h3 {
            color: #667eea;
            font-size: 0.95rem;
            margin-bottom: 8px;
        }

        .info-section p {
            color: #666;
            font-size: 0.85rem;
            line-height: 1.5;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Movie Discovery RAG System</h1>
            <p>Find movies by plot, theme, or mood using semantic search</p>
        </div>

        <div class="card">
            <div class="search-box">
                <input
                    type="text"
                    class="search-input"
                    id="queryInput"
                    placeholder="e.g., prison escape and redemption, or time travel paradox..."
                    autocomplete="off"
                >
                <button class="search-button" id="searchButton" onclick="performSearch()">
                    Search
                </button>
            </div>

            <div class="parameters">
                <div class="param-group">
                    <label for="topK">Top K Results (1-10)</label>
                    <input type="number" id="topK" min="1" max="10" value="3">
                </div>
                <div class="param-group">
                    <label for="threshold">Similarity Threshold (0-1)</label>
                    <input type="number" id="threshold" min="0" max="1" step="0.1" value="0.5">
                </div>
            </div>

            <div class="info-section">
                <h3>How it works</h3>
                <p>Search through 100 top-rated movies by describing plot elements, themes, or moods. The system uses semantic search to find movies matching your description, not just keywords. Try queries like "prison escape and redemption" or "time travel paradox".</p>
            </div>
        </div>

        <div id="resultsContainer"></div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:8000';

        // Allow search on Enter key
        document.getElementById('queryInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                performSearch();
            }
        });

        async function performSearch() {
            const query = document.getElementById('queryInput').value.trim();
            const topK = parseInt(document.getElementById('topK').value);
            const threshold = parseFloat(document.getElementById('threshold').value);
            const resultsContainer = document.getElementById('resultsContainer');
            const searchButton = document.getElementById('searchButton');

            if (!query) {
                showError('Please enter a query');
                return;
            }

            // Show loading state
            searchButton.disabled = true;
            searchButton.textContent = 'Searching...';
            resultsContainer.innerHTML = '<div class="card loading">Searching for relevant chunks...</div>';

            try {
                const response = await fetch(`${API_BASE_URL}/query`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        query: query,
                        top_k: topK,
                        similarity_threshold: threshold
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Search failed');
                }

                const data = await response.json();
                displayResults(data);

            } catch (error) {
                showError(error.message);
            } finally {
                searchButton.disabled = false;
                searchButton.textContent = 'Search';
            }
        }

        function displayResults(data) {
            const resultsContainer = document.getElementById('resultsContainer');

            if (data.results.length === 0) {
                resultsContainer.innerHTML = `
                    <div class="card empty-state">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <h3>No results found</h3>
                        <p>Try a different query or lower the similarity threshold</p>
                    </div>
                `;
                return;
            }

            let html = `
                <div class="card">
                    <div class="results-header">
                        <h2>Results</h2>
                        <span class="results-count">${data.total_results} chunk${data.total_results !== 1 ? 's' : ''} found</span>
                    </div>
                    <div class="results-container">
            `;

            data.results.forEach((result, index) => {
                const metadataHtml = Object.entries(result.metadata || {})
                    .map(([key, value]) => `<strong>${key}:</strong> ${value}`)
                    .join(' | ');

                html += `
                    <div class="result-item">
                        <div class="result-header">
                            <span class="result-id">Rank #${result.rank} - ${result.chunk_id}</span>
                            <span class="result-score">Score: ${result.similarity_score}</span>
                        </div>
                        <div class="result-content">${escapeHtml(result.content)}</div>
                        ${metadataHtml ? `<div class="result-metadata">${metadataHtml}</div>` : ''}
                    </div>
                `;
            });

            html += `
                    </div>
                </div>
            `;

            resultsContainer.innerHTML = html;
        }

        function showError(message) {
            const resultsContainer = document.getElementById('resultsContainer');
            resultsContainer.innerHTML = `
                <div class="card">
                    <div class="error">
                        <strong>Error:</strong> ${escapeHtml(message)}
                    </div>
                </div>
            `;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Check API health on load
        window.addEventListener('load', async () => {
            try {
                const response = await fetch(`${API_BASE_URL}/health`);
                if (!response.ok) {
                    throw new Error('API not available');
                }
                const data = await response.json();
                console.log('API Status:', data);
            } catch (error) {
                showError('Backend API is not available. Please make sure the server is running on port 8000.');
            }
        });
    </script>
</body>
</html>
